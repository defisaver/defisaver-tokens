name: Update Tokens

on:
  push:
    branches:
      - feature/go-token-files
  workflow_dispatch:

jobs:
  update-tokens:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout defisaver-tokens
        uses: actions/checkout@v4

      - name: Setup
        run: npm ci

      - name: Build package
        run: npm run build:umd

      - name: Run script
        run: npm run generate-go-files

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.TARGET_REPO }}
          path: target-repo
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: staging

      - name: Check if GO_FILE_PATH exists
        id: check-path
        env:
          GO_FILE_PATH: ${{ secrets.GO_FILE_PATH }}
        run: |
          if [ -d "target-repo/${{ secrets.GO_FILE_PATH }}" ]; then
            echo "path-exists=true" >> $GITHUB_OUTPUT
          else
            echo "path-exists=false" >> $GITHUB_OUTPUT
            echo "GO_FILE_PATH does not exist, ending workflow."
            exit 0
          fi

      - name: Copy generated files
        if: steps.check-path.outputs.path-exists == 'true'
        env:
          GO_FILE_PATH: ${{ secrets.GO_FILE_PATH }}
        run: |
          mkdir -p target-repo/$GO_FILE_PATH
          cp generated/*.go target-repo/$GO_FILE_PATH

      - name: Run go fmt on specific files
        if: steps.check-path.outputs.path-exists == 'true'
        env:
          GO_FILE_PATH: ${{ secrets.GO_FILE_PATH }}
        run: |
          cd target-repo
          go fmt $GO_FILE_PATH/*.go

      - name: Commit and push changes
        if: steps.check-path.outputs.path-exists == 'true'
        run: |
          cd target-repo
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git checkout -b ci/update-supported-tokens || git checkout ci/update-supported-tokens
          git add $GO_FILE_PATH/*.go
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update tokens files"
          git push origin ci/update-supported-tokens --force
          gh pr create --title "Update tokens files" --body "This PR updates the tokens files." --base staging --head ci/update-supported-tokens
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GO_FILE_PATH: ${{ secrets.GO_FILE_PATH }}
